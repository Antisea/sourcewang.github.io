---
layout: post
title: IIC - 学习笔记
---

## I2C 学习笔记

## I2C 总线特点
&nbsp; &nbsp; &nbsp; &nbsp;I2C总线最主要的优点是其简单性和有效性。由于接口直接在组件之上，因此I2C总线占用的空间非常小，减少了电路板的空间和芯片管脚的数量，降低了互联成本。总线的长度可高达25英尺，并且能够以10Kbps的最大传输速率支持40个组件。

&nbsp; &nbsp; &nbsp; &nbsp;I2C总线的另一个优点是，它支持多主控(multimastering)， 其中任何能够进行发送和接收的设备都可以成为主总线。一个主控能够控制信号的传输和时钟频率。当然，在任何时间点上只能有一个主控。 

## I2C 总线工作原理
* I2C总线上的数据稳定规则，SCL为高电平时SDA上的数据保持稳定，SCL为低电平时允许SDA变化。如果SCL处于高电平时，SDA上产生下降沿，则认为是起始位，SDA上的上升沿认为是停止位。通信速率分为常规模式(时钟频率100kHz)和快速模式(时钟频率400kHz)。

* 同一总线上可以连接多个带有I2C接口的器件，每个器件都有一个唯一的地址，既可以是单接收的器件，也可以是能够接收发送的器件。每次数据传输都是以一个起始位开始，而以停止位结束。传输的字节数没有限制。最高有效位将首先被传输，接收方收到第8位数据后会发出应答位。

* 数据传输通常分为两种：主设备发送从设备接收和从设备发送主设备接收。这两种模式都需要主机发送起始位和停止位，应答位由接收方产生。从设备地址一般是1或2个字节，用于区分连接在同一I2C上的不同器件。

* I2C 总线在传送数据过程中共有三种类型信号， 它们分别是：开始信号、结束信号和应答信号。 

  开始信号：SCL为高电平时，SDA由高电平向低电平跳变，开始传送数据。 
  结束信号：SCL为低电平时，SDA由低电平向高电平跳变，结束传送数据。 
  应答信号：接收数据的IC在接收到8bit数据后，向发送数据的IC发出特定的低电平脉冲，表示已收到数据。  

* CPU向受控单元发出一个信号后，等待受控单元发出一个应答信号，CPU接收到应答信号后，根据实际情况作出是否继续传递信号的判断。若未收到应答信号，由判断为受控单元出现故障。在I2C总线中只有主发送和主接收两种操作方式。  

> 在系统初始化时，由指令控制CPU送出相关的数据，经接口送到I2C寄存器内。通过初始化这些寄存器，可以实现I2C总线的主模式控制，以及实现I2C总线上的从设备读写。

> 当主设备和其中的一个从设备交换数据时，主设备首先发出一个启动Start信号，这个信号被所有的从设备接收。即从设备准备接收CPU的信号，然后主设备再发出它要通信的从设备地址。接下来，所有的从设备将收到的这个地址和它们自己的地址进行比较。

> 如果收到的地址和它们自己的地址不同，则什么都不做，只是等待主设备发出停止stop信号；如果收到的地址和它自己的地址相同，它就发出一个信号给主设备，这个信号称为应答**Acknowledge**信号。当主设备收到应答信号后，它就开始向从设备发送数据或者从从设备接收数据。当所有操作都进行完毕时，主设备发出一个Stop信号，通信完毕，释放I2C总线；然后所有的从设备都等待下一次Start信号的到来。

## IIC 总线基本操作

I2C规程运用主/从双向通讯。器件发送数据到总线上，则定义为发送器，器件接收数据则定义为接收器。

主器件和从器件都可以工作于接收和发送状态。

总线必须由主器件（通常为微控制器）控制，主器件产生串行时钟（SCL）控制总线的传输方向，并产生起始和停止条件。

SDA线上的数据状态仅在SCL为低电平的期间才能改变，SCL为高电平的期间，SDA状态的改变被用来表示起始和停止条件。

[出自 - http://www.doczj.com/doc/db8e8b37581b6bd97f19eaa6.html](http://www.doczj.com/doc/db8e8b37581b6bd97f19eaa6.html "doc之家")

## IIC 工作过程

I2C的协议包括起始和停止条件，数据有效性，响应，仲裁，时钟同步和地址广播等  

* 起始信号产生后，所有从机开始等待主机接下来广播的从机地址信号（SLAVE_ADDRESS），在I2C总线上每个设备的地址都是唯一的，当主机广播的地址与某个设备地址相同时，这个设备就被选中了，没被选中的设备将会忽略之后的数据信号。根据I2C协议，这个从机地址可以是7位或10位。
* 在地址位之后，是传输方向的选择位，该位为0时，表示后面的数据传输方向是由主机传输至从机。该位为1时，则相反。
* 从机接收到匹配的地址后，主机或从机会返回一个应答（A）或非应答（-A）信号，只有接收到应答信号后，主机才能继续发生或接受数据。
* 若配置的方向传输位为写数据，广播完地址，接收到应答信号后，主机开始正式向从机传输数据data，数据包的大小为8位，主机每发送完一个数据，都要等待从机的应答信号，重复这个过程，可以向从机传输N个信号，N没有大小限制。当数据传输结束后，主机向从机发送一个停止传输信号（P），表示不再传输数据。
* 若配置的方向传输为读数据，广播完地址，接收到应答信号后，从机开始向主机返回数据data，数据包大小为8位，从机每发送完一个数据，都会等待主机的应答信号，重复这个过程，可以返回N个数据，N没有大小限制。当主机希望停止接收数据时，就向从机返回一个**非应答信号**，则从机自动停止数据传输。

## 模拟IIC

所谓模拟IIC就是说直接用软件模拟GPIO接口，设定IIC的时序，而不是像硬件的方式，IIC时序以硬件的条件触发。

通过软件的方式手动将IIC的SDA或者SCL拉高拉低，来模拟真正的硬件

```此时，GPIO的接口方式一定不能使AF（复用）模式```

## I2C 读写操作

#### 写

 发送 start <br/>
 发送 slave address(r/w 位是低电平) <br/>
 发送 寄存器数 <br/>
 发送 data <br/>
 发送 stop <br/>

#### 读

 发送 start <br/>
 发送 slave address(r/w 位是低电平) <br/>
 发送 寄存器数 <br/>
 发送 start(重复启动) <br/>
 发送 slave address(r/w 位是高电平) <br/>
 读取 data <br/>
 发送 stop <br/>

## XXD

* 启动位之后是从地址，通常为7位。这个7位数据位被放置在一个字节的上7位，而LSB被用来存储r/w位。





